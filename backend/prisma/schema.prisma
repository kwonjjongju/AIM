// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Department {
  id        String   @id @default(uuid())
  name      String
  code      String   @unique
  color     String   @default("#6366F1")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users               User[]
  items               ImprovementItem[]
  relatedItems        ItemRelatedDepartment[]

  @@map("departments")
}

model User {
  id           String   @id @default(uuid())
  employeeId   String   @unique @map("employee_id")
  name         String
  email        String   @unique
  departmentId String   @map("department_id")
  role         String   // EMPLOYEE, DEPT_MANAGER, EXECUTIVE, ADMIN
  passwordHash String   @map("password_hash")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  department      Department        @relation(fields: [departmentId], references: [id])
  createdItems    ImprovementItem[] @relation("CreatedBy")
  assignedItems   ImprovementItem[] @relation("AssignedTo")
  statusHistories StatusHistory[]
  attachments     Attachment[]

  @@map("users")
}

model ImprovementItem {
  id           String   @id @default(uuid())
  title        String
  description  String?
  gitUrl       String?  @map("git_url")
  webUrl       String?  @map("web_url")
  departmentId String   @map("department_id")
  status       String   @default("IDEA") // IDEA, REVIEWING, IN_PROGRESS, ON_HOLD, DONE
  createdBy    String   @map("created_by")
  assignedTo   String?  @map("assigned_to")
  isDeleted    Boolean  @default(false) @map("is_deleted")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  department         Department              @relation(fields: [departmentId], references: [id])
  creator            User                    @relation("CreatedBy", fields: [createdBy], references: [id])
  assignee           User?                   @relation("AssignedTo", fields: [assignedTo], references: [id])
  statusHistories    StatusHistory[]
  attachments        Attachment[]
  relatedDepartments ItemRelatedDepartment[]

  @@index([departmentId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("improvement_items")
}

model StatusHistory {
  id         String   @id @default(uuid())
  itemId     String   @map("item_id")
  fromStatus String?  @map("from_status")
  toStatus   String   @map("to_status")
  changedBy  String   @map("changed_by")
  note       String?
  changedAt  DateTime @default(now()) @map("changed_at")

  item    ImprovementItem @relation(fields: [itemId], references: [id])
  changer User            @relation(fields: [changedBy], references: [id])

  @@index([itemId])
  @@map("status_histories")
}

model Attachment {
  id         String   @id @default(uuid())
  itemId     String   @map("item_id")
  fileName   String   @map("file_name")
  filePath   String   @map("file_path")
  fileSize   Int      @map("file_size")
  mimeType   String   @map("mime_type")
  uploadedBy String   @map("uploaded_by")
  uploadedAt DateTime @default(now()) @map("uploaded_at")

  item     ImprovementItem @relation(fields: [itemId], references: [id])
  uploader User            @relation(fields: [uploadedBy], references: [id])

  @@index([itemId])
  @@map("attachments")
}

model ItemRelatedDepartment {
  itemId       String @map("item_id")
  departmentId String @map("department_id")

  item       ImprovementItem @relation(fields: [itemId], references: [id])
  department Department      @relation(fields: [departmentId], references: [id])

  @@id([itemId, departmentId])
  @@map("item_related_departments")
}

model AIToolUser {
  id        Int      @id @default(autoincrement())
  division  String   @default("")
  team      String   @default("")
  name      String   @default("")
  email     String   @default("")
  skywork   Boolean  @default(false)
  gemini    Boolean  @default(false)
  chatgpt   Boolean  @default(false)
  cursor    Boolean  @default(false)
  claude    Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("ai_tool_users")
}
